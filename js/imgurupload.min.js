/*global gdn, jQuery */
(function(e){"use strict";var t=function(e,t){var n,a,i;t+="\n",document.selection?(e.focus(),n=document.selection.createRange(),n.text=t):e.selectionStart||"0"==e.selectionStart?(a=e.selectionStart,i=e.selectionEnd,e.value=e.value.substring(0,a)+t+e.value.substring(i,e.value.length)):e.value+=t},n=function(e){var t,n=gdn.definition("InputFormat");switch(n.toLowerCase()){case"bbcode":t="[img]"+e.link+"[/img]";break;case"markdown":t="![]("+e.link+")";break;case"html":t='<img src="'+e.link+'" alt="" width="'+e.width+'" height="'+e.height+'" />';break;default:t=e.link}return t},a=function(e,a,i){return{success:function(a,i){i.success?t(e[0],n(i.data)):alert("Something went wrong trying to upload your images :( \n\nOur image host, imgur.com, may be having technical issues. Give it a few minutes and try again.")},acceptedFiles:"image/*",paramName:"image",clickable:i,method:"post",maxFilesize:20,maxFiles:20,previewsContainer:a[0],thumbnailWidth:60,thumbnailHeight:60,fallback:function(){},url:"https://api.imgur.com/3/upload",headers:{Authorization:"Client-ID "+gdn.definition("imgurclientid"),Accept:"application/json"}}};e(function(){var i,o=e("#Form_Body"),r=o.parents("form"),c=r.find("[type=submit]").last(),s=e("<div/>",{"class":"imguruploader-preview-ctx"});o.attr("placeholder","You can now drag and drop images here to add them to your post! They will appear wherever your caret is."),o.after(s),o.dropzone(a(o,s,!1)),"ontouchstart"in window&&(o.attr("placeholder",""),i=e('<a href="#" class="Button ButtonAddImages">Add Images</a>'),c.before(i),i.dropzone(a(o,s,!0)),i.on("click",function(e){e.preventDefault()})),c.on("click",function(){s.empty()}),"1"===gdn.definition("processimageurls")&&o.on("drop",function(e){var a=(e.originalEvent,e.originalEvent.dataTransfer.getData("URL"));a.length&&(e.preventDefault(),e.stopPropagation(),a.match(/([a-z\-_0-9\/\:\.]*\.(jpg|jpeg|png|gif))/i)?t(o[0],n({link:a})):t(o[0],a))})})})(jQuery);